# ğŸ” æ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG)

> ğŸ“Š **è€ƒè¯•å æ¯”**: 24% (~24 é¢˜)
>
> ğŸ¯ **é‡è¦ç¨‹åº¦**: â­â­â­â­â­ æ ¸å¿ƒæ¨¡å—

## ğŸ“š çŸ¥è¯†å¤§çº²

### 1. RAG åŸºç¡€æ¦‚å¿µ

#### 1.1 ä»€ä¹ˆæ˜¯ RAG

- **R**etrieval-**A**ugmented **G**eneration
- æ£€ç´¢å¢å¼ºç”Ÿæˆï¼šå°†å¤–éƒ¨çŸ¥è¯†æ£€ç´¢ä¸å¤§æ¨¡å‹ç”Ÿæˆç»“åˆ
- è§£å†³å¤§æ¨¡å‹çŸ¥è¯†æ—¶æ•ˆæ€§å’Œä¸“ä¸šé¢†åŸŸçŸ¥è¯†ç¼ºå¤±é—®é¢˜

#### 1.2 RAG vs å¾®è°ƒ

| ç»´åº¦       | RAG          | å¾®è°ƒ          |
| ---------- | ------------ | ------------- |
| çŸ¥è¯†æ›´æ–°   | âœ… å®æ—¶æ›´æ–°  | âŒ éœ€é‡æ–°è®­ç»ƒ |
| æˆæœ¬       | ä½           | é«˜            |
| å¯è§£é‡Šæ€§   | âœ… å¯æº¯æº    | âŒ é»‘ç›’       |
| é¢†åŸŸé€‚åº”   | çŸ¥è¯†è¡¥å……     | é£æ ¼/æ ¼å¼è°ƒæ•´ |
| éƒ¨ç½²å¤æ‚åº¦ | éœ€è¦æ£€ç´¢ç³»ç»Ÿ | ä»…æ¨¡å‹æ–‡ä»¶    |

#### 1.3 RAG æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RAG ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ–‡æ¡£åº“    â”‚ â†’ â”‚ æ–‡æ¡£å¤„ç†   â”‚ â†’ â”‚ å‘é‡æ•°æ®åº“             â”‚ â”‚
â”‚  â”‚ PDF/Word â”‚    â”‚ åˆ‡ç‰‡/å‘é‡åŒ–â”‚    â”‚ (Milvus/FAISS/ES)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â†‘               â”‚
â”‚                                              â”‚ æ£€ç´¢          â”‚
â”‚                                              â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç”¨æˆ·é—®é¢˜  â”‚ â†’ â”‚ Queryå‘é‡åŒ–â”‚ â†’ â”‚ ç›¸ä¼¼åº¦åŒ¹é… + é‡æ’åº    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚               â”‚
â”‚                                              â†“               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ€ç»ˆå›ç­”  â”‚ â† â”‚ LLM ç”Ÿæˆ   â”‚ â† â”‚ Prompt + æ£€ç´¢ç»“æœ      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. RAG å››å¤§æ ¸å¿ƒè¦ç´  â­

#### 2.1 æ–‡æ¡£è§£æ (Document Parsing)

```python
# æ”¯æŒçš„æ–‡æ¡£æ ¼å¼
formats = {
    "æ–‡æœ¬": [".txt", ".md", ".json"],
    "æ–‡æ¡£": [".pdf", ".docx", ".pptx"],
    "ç½‘é¡µ": [".html"],
    "ç»“æ„åŒ–": [".csv", ".xlsx"]
}

# è§£ææŒ‘æˆ˜
challenges = [
    "PDF è¡¨æ ¼æå–",
    "æ‰«æä»¶ OCR",
    "å¤šæ¨¡æ€å†…å®¹",
    "æ ¼å¼ä¿æŒ"
]
```

#### 2.2 æ–‡æœ¬åˆ‡ç‰‡ (Text Chunking)

| åˆ‡ç‰‡ç­–ç•¥     | æè¿°           | é€‚ç”¨åœºæ™¯        |
| ------------ | -------------- | --------------- |
| **å›ºå®šå¤§å°** | æŒ‰å­—ç¬¦æ•°åˆ‡åˆ†   | é€šç”¨åœºæ™¯        |
| **å¥å­åˆ‡åˆ†** | æŒ‰å¥å­è¾¹ç•Œåˆ‡åˆ† | å¯¹è¯/QA         |
| **æ®µè½åˆ‡åˆ†** | æŒ‰æ®µè½è¾¹ç•Œåˆ‡åˆ† | é•¿æ–‡æ¡£          |
| **è¯­ä¹‰åˆ‡åˆ†** | æŒ‰è¯­ä¹‰å…³è”åˆ‡åˆ† | é«˜è´¨é‡æ£€ç´¢      |
| **é€’å½’åˆ‡åˆ†** | å±‚çº§é€’å½’åˆ‡åˆ†   | LlamaIndex é»˜è®¤ |

```python
# LlamaIndex åˆ‡ç‰‡ç¤ºä¾‹
from llama_index.core.node_parser import SentenceSplitter

splitter = SentenceSplitter(
    chunk_size=512,        # æ¯å—å¤§å°
    chunk_overlap=50,      # é‡å åŒºåŸŸ
    separator=" "          # åˆ†éš”ç¬¦
)
```

**åˆ‡ç‰‡å‚æ•°æƒè¡¡**:

- `chunk_size â†‘` â†’ ä¸Šä¸‹æ–‡æ›´å®Œæ•´ï¼Œä½†å™ªéŸ³å¯èƒ½æ›´å¤š
- `chunk_overlap â†‘` â†’ è¾¹ç•Œä¿¡æ¯ä¿æŒæ›´å¥½ï¼Œä½†å­˜å‚¨æˆæœ¬å‡é«˜

#### 2.3 æ®µè½å¬å› (Retrieval)

**æ£€ç´¢æ–¹å¼å¯¹æ¯”**:

| æ–¹å¼         | åŸç†        | ä¼˜ç‚¹       | ç¼ºç‚¹       |
| ------------ | ----------- | ---------- | ---------- |
| **ç¨€ç–æ£€ç´¢** | BM25/TF-IDF | ç²¾ç¡®åŒ¹é…å¥½ | è¯­ä¹‰ç†è§£å¼± |
| **ç¨ å¯†æ£€ç´¢** | å‘é‡ç›¸ä¼¼åº¦  | è¯­ä¹‰ç†è§£å¼º | ç²¾ç¡®åŒ¹é…å¼± |
| **æ··åˆæ£€ç´¢** | ä¸¤è€…ç»“åˆ    | äº’è¡¥ä¼˜åŠ¿   | å¤æ‚åº¦é«˜   |

```python
# å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
# ä½™å¼¦ç›¸ä¼¼åº¦ (å¸¸ç”¨)
cosine_sim = dot(A, B) / (norm(A) * norm(B))

# æ¬§æ°è·ç¦»
euclidean_dist = sqrt(sum((A - B)^2))

# å†…ç§¯
inner_product = dot(A, B)
```

#### 2.4 é‡æ’åº (Re-ranking)

```
åˆæ­¥æ£€ç´¢ (Top 100) â†’ é‡æ’åºæ¨¡å‹ â†’ ç²¾æ’ç»“æœ (Top 5)
```

**é‡æ’åºä½œç”¨**:

- å¼¥è¡¥å‘é‡æ£€ç´¢çš„è¯­ä¹‰åå·®
- æé«˜æœ€ç»ˆæ£€ç´¢ç»“æœçš„ç›¸å…³æ€§
- ä½¿ç”¨æ›´ç²¾ç»†çš„æ¨¡å‹è¿›è¡ŒäºŒæ¬¡æ’åº

### 3. RAG å¬å›ä¼˜åŒ– â­

#### 3.1 å¥å­çª—å£æ£€ç´¢ (Sentence Window)

```
æ£€ç´¢å•å…ƒ: å¥å­
è¿”å›å•å…ƒ: å¥å­ + å‰å N ä¸ªå¥å­

ä¼˜ç‚¹: ç²¾ç¡®å®šä½ + ä¿æŒä¸Šä¸‹æ–‡
```

```python
# LlamaIndex å®ç°
from llama_index.core.node_parser import SentenceWindowNodeParser

parser = SentenceWindowNodeParser.from_defaults(
    window_size=3,           # å‰åå„ 3 å¥
    window_metadata_key="window",
    original_text_metadata_key="original_text"
)
```

#### 3.2 è‡ªåŠ¨åˆå¹¶æ£€ç´¢ (Auto-Merging)

```
å°å—æ£€ç´¢ â†’ å¦‚æœå¤šä¸ªå°å—æ¥è‡ªåŒä¸€çˆ¶å— â†’ è¿”å›çˆ¶å—

å±‚çº§ç»“æ„:
- å¤§å— (512 tokens): çˆ¶èŠ‚ç‚¹
  - å°å— (128 tokens): å­èŠ‚ç‚¹
  - å°å— (128 tokens): å­èŠ‚ç‚¹
```

```python
# LlamaIndex å®ç°
from llama_index.core.node_parser import HierarchicalNodeParser

parser = HierarchicalNodeParser.from_defaults(
    chunk_sizes=[512, 128]  # çˆ¶å—512, å­å—128
)
```

#### 3.3 æ··åˆæ£€ç´¢

```python
# ç»“åˆç¨€ç– + ç¨ å¯†æ£€ç´¢
hybrid_score = alpha * sparse_score + (1 - alpha) * dense_score

# alpha é€šå¸¸å– 0.3 - 0.5
```

### 4. RAGAS è¯„æµ‹ä½“ç³» â­

#### 4.1 å››å¤§æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡             | è‹±æ–‡              | è¯„ä¼°ç»´åº¦             | è®¡ç®—ä¾æ®                |
| ---------------- | ----------------- | -------------------- | ----------------------- |
| **å¿ å®åº¦**       | Faithfulness      | ç­”æ¡ˆæ˜¯å¦åŸºäºæ£€ç´¢å†…å®¹ | Answer vs Context       |
| **ç­”æ¡ˆç›¸å…³æ€§**   | Answer Relevancy  | ç­”æ¡ˆæ˜¯å¦å›ç­”äº†é—®é¢˜   | Answer vs Question      |
| **ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦** | Context Precision | æ£€ç´¢ç»“æœæ˜¯å¦ç²¾ç¡®     | Context vs Question     |
| **ä¸Šä¸‹æ–‡å¬å›**   | Context Recall    | æ£€ç´¢æ˜¯å¦å®Œæ•´         | Context vs Ground Truth |

```python
# RAGAS è¯„æµ‹æµç¨‹
from ragas import evaluate
from ragas.metrics import (
    faithfulness,
    answer_relevancy,
    context_precision,
    context_recall
)

result = evaluate(
    dataset,
    metrics=[
        faithfulness,
        answer_relevancy,
        context_precision,
        context_recall
    ]
)
```

#### 4.2 æŒ‡æ ‡è®¡ç®—åŸç†

```
Faithfulness = ç­”æ¡ˆä¸­å¯ç”±Contextæ”¯æ’‘çš„é™ˆè¿°æ•° / ç­”æ¡ˆæ€»é™ˆè¿°æ•°

Answer Relevancy = ç”Ÿæˆé—®é¢˜ä¸åŸé—®é¢˜çš„ç›¸ä¼¼åº¦å¹³å‡å€¼

Context Precision = ç›¸å…³Contextæ’åçš„åŠ æƒå¹³å‡

Context Recall = Ground Truth ä¸­è¢« Context è¦†ç›–çš„æ¯”ä¾‹
```

### 5. LlamaIndex å®è·µ

#### 5.1 åŸºç¡€ RAG æµç¨‹

```python
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader
from llama_index.llms.dashscope import DashScope
from llama_index.embeddings.dashscope import DashScopeEmbedding

# 1. åŠ è½½æ–‡æ¡£
documents = SimpleDirectoryReader("./data").load_data()

# 2. é…ç½®æ¨¡å‹
llm = DashScope(model_name="qwen-max", api_key="xxx")
embed_model = DashScopeEmbedding()

# 3. åˆ›å»ºç´¢å¼•
index = VectorStoreIndex.from_documents(
    documents,
    embed_model=embed_model
)

# 4. åˆ›å»ºæŸ¥è¯¢å¼•æ“
query_engine = index.as_query_engine(llm=llm)

# 5. æŸ¥è¯¢
response = query_engine.query("ä»€ä¹ˆæ˜¯RAG?")
```

#### 5.2 ç™¾ç‚¼çŸ¥è¯†åº“é›†æˆ

```python
# ä½¿ç”¨ç™¾ç‚¼å¹³å°çŸ¥è¯†åº“
from dashscope import Application

response = Application.call(
    app_id="your_app_id",
    prompt="æŸ¥è¯¢å†…å®¹",
    # å¯ç”¨çŸ¥è¯†åº“æ£€ç´¢
    rag_options={
        "pipeline_id": "your_pipeline_id",
        "retrieve_top_n": 5
    }
)
```

---

## âœ… çŸ¥è¯†ç‚¹è‡ªæµ‹

1. [ ] RAG å’Œå¾®è°ƒçš„ä¸»è¦åŒºåˆ«?
2. [ ] RAG å››å¤§æ ¸å¿ƒè¦ç´ æ˜¯ä»€ä¹ˆ?
3. [ ] å¥å­çª—å£æ£€ç´¢çš„åŸç†?
4. [ ] RAGAS å››ä¸ªè¯„æµ‹æŒ‡æ ‡åˆ†åˆ«è¯„ä¼°ä»€ä¹ˆ?
5. [ ] æ··åˆæ£€ç´¢çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆ?

---

## ğŸ“ è€ƒç‚¹é€Ÿè®°å¡

```
ğŸ”¹ RAG = æ£€ç´¢ + ç”Ÿæˆï¼ŒçŸ¥è¯†å¯æ›´æ–°
ğŸ”¹ å››è¦ç´  = è§£æ â†’ åˆ‡ç‰‡ â†’ å¬å› â†’ é‡æ’
ğŸ”¹ chunk_size â†‘ = ä¸Šä¸‹æ–‡ â†‘ + å™ªéŸ³ â†‘
ğŸ”¹ å¥å­çª—å£ = ç²¾ç¡®æ£€ç´¢ + ä¸Šä¸‹æ–‡è¡¥å……
ğŸ”¹ è‡ªåŠ¨åˆå¹¶ = å°å—æ£€ç´¢ â†’ çˆ¶å—è¿”å›
ğŸ”¹ RAGAS = F(å¿ å®) + AR(ç­”æ¡ˆ) + CP(ç²¾ç¡®) + CR(å¬å›)
ğŸ”¹ æ··åˆæ£€ç´¢ = ç¨€ç–(ç²¾ç¡®) + ç¨ å¯†(è¯­ä¹‰)
```
