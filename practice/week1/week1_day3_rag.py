"""
Week 1 Day 3-5: RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ
é˜¿é‡Œäº‘å¤§æ¨¡å‹ACPè®¤è¯å¤‡è€ƒ - è€ƒè¯•å æ¯” 24%

è¿è¡Œ: python week1_day3_rag.py
ä¾èµ–: pip install llama-index llama-index-llms-dashscope llama-index-embeddings-dashscope
"""

import os

API_KEY = os.getenv("DASHSCOPE_API_KEY", "your_api_key_here")


def exercise1_rag_flow():
    """ç»ƒä¹ 1: RAG æ ¸å¿ƒæµç¨‹"""
    print("=" * 60)
    print("ç»ƒä¹ 1: RAG æ ¸å¿ƒæµç¨‹")
    print("=" * 60)

    print("""
ğŸ“Š RAG æµç¨‹ (å¿…è€ƒ)

  æ–‡æ¡£ â†’ è§£æ â†’ åˆ‡ç‰‡ â†’ å‘é‡åŒ– â†’ ç´¢å¼•å­˜å‚¨
                                    â†“
  ç­”æ¡ˆ â† ç”Ÿæˆ â† é‡æ’åº â† æ£€ç´¢ â† ç”¨æˆ·æŸ¥è¯¢

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å››å¤§æ ¸å¿ƒè¦ç´ :                                                â”‚
â”‚ 1. æ–‡æ¡£è§£æ (Document Parsing) - PDF/Word/HTMLè§£æ          â”‚
â”‚ 2. æ–‡æœ¬åˆ‡ç‰‡ (Chunking) - å›ºå®šå¤§å°/å¥å­/è¯­ä¹‰åˆ‡åˆ†             â”‚
â”‚ 3. å‘é‡æ£€ç´¢ (Retrieval) - ç¨ å¯†/ç¨€ç–/æ··åˆæ£€ç´¢               â”‚
â”‚ 4. é‡æ’åº (Re-ranking) - ç²¾æ’æå‡ç›¸å…³æ€§                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ RAG vs å¾®è°ƒ:
  - RAG: çŸ¥è¯†å¯æ›´æ–°ï¼Œå¯æº¯æºï¼Œæˆæœ¬ä½
  - å¾®è°ƒ: æ”¹å˜è¡Œä¸ºé£æ ¼ï¼Œå­¦ä¹ æ–°æ¦‚å¿µ
""")


def exercise2_chunking():
    """ç»ƒä¹ 2: æ–‡æœ¬åˆ‡ç‰‡ç­–ç•¥"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ 2: æ–‡æœ¬åˆ‡ç‰‡ç­–ç•¥")
    print("=" * 60)

    print("""
ğŸ“Š åˆ‡ç‰‡å‚æ•°å½±å“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°            â”‚ å½±å“                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ chunk_size â†‘   â”‚ ä¸Šä¸‹æ–‡æ›´å®Œæ•´ï¼Œä½†å™ªéŸ³å¯èƒ½æ›´å¤š              â”‚
â”‚ chunk_size â†“   â”‚ æ£€ç´¢æ›´ç²¾ç¡®ï¼Œä½†å¯èƒ½ä¸¢å¤±ä¸Šä¸‹æ–‡              â”‚
â”‚ overlap â†‘      â”‚ è¾¹ç•Œä¿¡æ¯ä¿æŒæ›´å¥½ï¼Œå­˜å‚¨æˆæœ¬å‡é«˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š åˆ‡ç‰‡ç­–ç•¥:
  - å›ºå®šå¤§å°: ç®€å•é€šç”¨
  - å¥å­åˆ‡åˆ†: é€‚åˆå¯¹è¯QA
  - è¯­ä¹‰åˆ‡åˆ†: é«˜è´¨é‡æ£€ç´¢
  - é€’å½’åˆ‡åˆ†: LlamaIndexé»˜è®¤

ä»£ç ç¤ºä¾‹:
```python
from llama_index.core.node_parser import SentenceSplitter
splitter = SentenceSplitter(chunk_size=512, chunk_overlap=50)
```
""")


def exercise3_retrieval():
    """ç»ƒä¹ 3: æ£€ç´¢ä¼˜åŒ–"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ 3: æ£€ç´¢ä¼˜åŒ–")
    print("=" * 60)

    print("""
ğŸ“Š æ£€ç´¢æ–¹å¼å¯¹æ¯”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å¼        â”‚ åŸç†            â”‚ ç‰¹ç‚¹            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¨€ç–æ£€ç´¢    â”‚ BM25/TF-IDF     â”‚ ç²¾ç¡®åŒ¹é…å¥½      â”‚
â”‚ ç¨ å¯†æ£€ç´¢    â”‚ å‘é‡ç›¸ä¼¼åº¦       â”‚ è¯­ä¹‰ç†è§£å¼º      â”‚
â”‚ æ··åˆæ£€ç´¢    â”‚ ä¸¤è€…åŠ æƒèåˆ     â”‚ äº’è¡¥æœ€ä¼˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ··åˆæ£€ç´¢å…¬å¼: hybrid = Î± Ã— sparse + (1-Î±) Ã— dense

ğŸ“Š é«˜çº§ä¼˜åŒ–:
  - å¥å­çª—å£: æ£€ç´¢å¥å­ï¼Œè¿”å›å¥å­+ä¸Šä¸‹æ–‡
  - è‡ªåŠ¨åˆå¹¶: å°å—æ£€ç´¢ï¼Œçˆ¶å—è¿”å›

ğŸ’¡ è€ƒç‚¹é€Ÿè®°:
  - ç¨€ç– = BM25, ç²¾ç¡®åŒ¹é…
  - ç¨ å¯† = å‘é‡, è¯­ä¹‰ç†è§£
  - æ··åˆ = äº’è¡¥ä¼˜åŠ¿
""")


def exercise4_ragas():
    """ç»ƒä¹ 4: RAGAS è¯„æµ‹"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ 4: RAGAS è¯„æµ‹ä½“ç³»")
    print("=" * 60)

    print("""
ğŸ“Š RAGAS å››å¤§æŒ‡æ ‡ (é«˜é¢‘è€ƒç‚¹)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                 â”‚ è¯„ä¼°                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Faithfulness        â”‚ ç­”æ¡ˆæ˜¯å¦åŸºäºæ£€ç´¢å†…å®¹                 â”‚
â”‚ (å¿ å®åº¦)            â”‚ Answer vs Context                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Answer Relevancy    â”‚ ç­”æ¡ˆæ˜¯å¦å›ç­”äº†é—®é¢˜                   â”‚
â”‚ (ç­”æ¡ˆç›¸å…³æ€§)        â”‚ Answer vs Question                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Context Precision   â”‚ æ£€ç´¢ç»“æœæ˜¯å¦ç²¾ç¡®                     â”‚
â”‚ (ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦)      â”‚ Context vs Question                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Context Recall      â”‚ æ£€ç´¢æ˜¯å¦å®Œæ•´                         â”‚
â”‚ (ä¸Šä¸‹æ–‡å¬å›)        â”‚ Context vs Ground Truth             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ é€Ÿè®°: F(å¿ å®) + AR(ç­”æ¡ˆ) + CP(ç²¾ç¡®) + CR(å¬å›)
""")


def exercise5_basic_rag():
    """ç»ƒä¹ 5: LlamaIndex RAG ä»£ç """
    print("\n" + "=" * 60)
    print("ç»ƒä¹ 5: LlamaIndex å®ç°")
    print("=" * 60)

    if API_KEY == "your_api_key_here":
        print("\nâš ï¸ éœ€è¦è®¾ç½® DASHSCOPE_API_KEY è¿è¡Œå®é™…ä»£ç ")

    print("""
ğŸ“ åŸºç¡€ RAG ä»£ç :

```python
from llama_index.core import VectorStoreIndex, Document, Settings
from llama_index.llms.dashscope import DashScope
from llama_index.embeddings.dashscope import DashScopeEmbedding

# é…ç½®æ¨¡å‹
Settings.llm = DashScope(model_name="qwen-max", api_key=API_KEY)
Settings.embed_model = DashScopeEmbedding(model_name="text-embedding-v2")

# åˆ›å»ºæ–‡æ¡£å’Œç´¢å¼•
documents = [Document(text="ç™¾ç‚¼æ˜¯é˜¿é‡Œäº‘å¤§æ¨¡å‹å¹³å°...")]
index = VectorStoreIndex.from_documents(documents)

# æŸ¥è¯¢
query_engine = index.as_query_engine(similarity_top_k=3)
response = query_engine.query("ä»€ä¹ˆæ˜¯ç™¾ç‚¼ï¼Ÿ")
```

ğŸ’¡ å…³é”®å‚æ•°:
  - similarity_top_k: æ£€ç´¢è¿”å›æ–‡æ¡£æ•°
  - VectorStoreIndex: å‘é‡ç´¢å¼•æ ¸å¿ƒç±»
""")


def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     Week 1 Day 3-5: RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ                      â•‘
â•‘     é˜¿é‡Œäº‘å¤§æ¨¡å‹ACPè®¤è¯å¤‡è€ƒ (24%)                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
    exercises = {
        "1": exercise1_rag_flow,
        "2": exercise2_chunking,
        "3": exercise3_retrieval,
        "4": exercise4_ragas,
        "5": exercise5_basic_rag,
    }

    print("é€‰æ‹©: 1.RAGæµç¨‹ 2.åˆ‡ç‰‡ 3.æ£€ç´¢ 4.RAGAS 5.ä»£ç å®ç° 0.å…¨éƒ¨")
    choice = input("è¯·é€‰æ‹© (0-5): ").strip()

    if choice == "0":
        for f in exercises.values():
            f()
    elif choice in exercises:
        exercises[choice]()

    print("\nâœ… Week 1 Day 3-5 å®Œæˆï¼")


if __name__ == "__main__":
    main()
